<div class="modal-header">
    <h3 class="modal-title">
        <i class="glyphicon glyphicon-map-marker"></i> 
        Gestão de Pontos: {{ campaign._id }}
    </h3>
</div>
<div class="modal-body" style="max-height: 700px; overflow-y: auto;">
    <!-- Header com estatísticas -->
    <div class="row">
        <div class="col-md-8">
            <div class="row">
                <div class="col-xs-3">
                    <div class="well well-sm text-center">
                        <h4 class="text-primary">{{ totalPoints }}</h4>
                        <small>Total</small>
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="well well-sm text-center">
                        <h4 class="text-success">{{ campaign.completedPoints }}</h4>
                        <small>Completos</small>
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="well well-sm text-center">
                        <h4 class="text-warning">{{ totalPoints - campaign.completedPoints }}</h4>
                        <small>Pendentes</small>
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="well well-sm text-center">
                        <h4 class="text-info">{{ campaign.progress }}%</h4>
                        <small>Progresso</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="btn-group-vertical btn-block">
                <button class="btn btn-info btn-sm" ng-click="toggleAdvancedFilters()">
                    <i class="glyphicon glyphicon-filter"></i> 
                    {{ showAdvancedFilters ? 'Ocultar Filtros' : 'Filtros Avançados' }}
                </button>
                <button class="btn btn-warning btn-sm" ng-click="toggleInspectionViewer()">
                    <i class="glyphicon glyphicon-eye-open"></i> 
                    Visualizar Inspeções
                </button>
                <button class="btn btn-danger btn-sm" ng-click="toggleInspectionRemover()">
                    <i class="glyphicon glyphicon-trash"></i> 
                    Remover Inspeções
                </button>
            </div>
        </div>
    </div>

    <!-- Filtros Avançados -->
    <div ng-show="showAdvancedFilters" class="panel panel-default" style="margin-top: 15px;">
        <div class="panel-heading">
            <h5><i class="glyphicon glyphicon-filter"></i> Filtros Avançados</h5>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>ID do Ponto:</label>
                        <input type="text" 
                               class="form-control input-sm" 
                               ng-model="filters.pointId" 
                               placeholder="Buscar por ID...">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Status:</label>
                        <select class="form-control input-sm" 
                                ng-model="filters.status">
                            <option value="">Todos</option>
                            <option value="completed">Completos</option>
                            <option value="in_progress">Em Andamento</option>
                            <option value="not_started">Não Iniciados</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Usuário/Inspetor:</label>
                        <select class="form-control input-sm" 
                                ng-model="filters.user">
                            <option value="">Todos</option>
                            <option ng-repeat="user in availableUsers" value="{{user}}">{{user}}</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Bioma:</label>
                        <select class="form-control input-sm" 
                                ng-model="filters.biome">
                            <option value="">Todos</option>
                            <option ng-repeat="biome in availableBiomes" value="{{biome}}">{{biome}}</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Estado (UF):</label>
                        <select class="form-control input-sm" 
                                ng-model="filters.uf">
                            <option value="">Todos</option>
                            <option ng-repeat="uf in availableUfs" value="{{uf}}">{{uf}}</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Município:</label>
                        <select class="form-control input-sm" 
                                ng-model="filters.county">
                            <option value="">Todos</option>
                            <option ng-repeat="county in availableCounties" value="{{county}}">{{county}}</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Min. Inspeções:</label>
                        <input type="number" 
                               class="form-control input-sm" 
                               ng-model="filters.minInspections" 
                               placeholder="0"
                               min="0">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Max. Inspeções:</label>
                        <input type="number" 
                               class="form-control input-sm" 
                               ng-model="filters.maxInspections" 
                               placeholder="Sem limite"
                               min="0">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <button class="btn btn-default btn-sm" ng-click="clearAllFilters()">
                        <i class="glyphicon glyphicon-remove"></i> Limpar Filtros
                    </button>
                    <button class="btn btn-primary btn-sm" ng-click="applyFilters()" style="margin-left: 5px;">
                        <i class="glyphicon glyphicon-search"></i> Aplicar Filtros
                    </button>
                    <span class="text-muted pull-right">
                        <small ng-if="hasActiveFilters()">{{ totalPoints }} pontos encontrados com os filtros aplicados</small>
                        <small ng-if="!hasActiveFilters()">{{ totalPoints }} pontos no total</small>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Visualizador de Inspeções -->
    <div ng-show="showInspectionViewer" class="panel panel-info" style="margin-top: 15px;">
        <div class="panel-heading">
            <h5><i class="glyphicon glyphicon-eye-open"></i> Visualizador de Inspeções por Inspetor</h5>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Selecionar Inspetor:</label>
                        <select class="form-control" 
                                ng-model="selectedInspector" 
                                ng-change="loadInspectorDetails()">
                            <option value="">Escolha um inspetor...</option>
                            <option ng-repeat="inspector in inspectorsList" value="{{inspector.name}}">
                                {{inspector.name}} ({{inspector.inspectionCount}} inspeções)
                            </option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6" ng-show="selectedInspector">
                    <div class="well well-sm">
                        <strong>Estatísticas do Inspetor:</strong><br>
                        <small>
                            Total de inspeções: {{ inspectorStats.totalInspections }}<br>
                            Pontos únicos: {{ inspectorStats.uniquePoints }}<br>
                            Tempo médio: {{ inspectorStats.averageTime }} segundos
                        </small>
                    </div>
                </div>
            </div>
            <div ng-show="selectedInspector && inspectorPoints.length > 0">
                <table class="table table-striped table-condensed">
                    <thead>
                        <tr>
                            <th>ID Ponto</th>
                            <th>Lat/Lon</th>
                            <th>Município</th>
                            <th>Data Inspeção</th>
                            <th>Tempo (s)</th>
                            <th>Classes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="point in inspectorPoints | limitTo:10">
                            <td>{{ point._id }}</td>
                            <td>{{ point.lat | number:4 }}, {{ point.lon | number:4 }}</td>
                            <td>{{ point.county || '-' }}</td>
                            <td>{{ point.inspectionDate | date:'dd/MM/yyyy HH:mm' }}</td>
                            <td>{{ point.inspectionTime || '-' }}</td>
                            <td>
                                <span ng-repeat="cls in point.landUseClasses" class="label label-default" style="margin-right: 2px;">
                                    {{ cls }}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div ng-show="inspectorPoints.length > 10" class="text-center">
                    <small class="text-muted">Mostrando apenas os primeiros 10 resultados</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Removedor de Inspeções -->
    <div ng-show="showInspectionRemover" class="panel panel-danger" style="margin-top: 15px;">
        <div class="panel-heading">
            <h5><i class="glyphicon glyphicon-trash"></i> Remoção Segura de Inspeções</h5>
        </div>
        <div class="panel-body">
            <div class="alert alert-warning">
                <strong>Atenção:</strong> Esta ferramenta permite remover inspeções indesejadas. 
                Use com cuidado para evitar perda de dados.
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Critério de Remoção:</label>
                        <select class="form-control" ng-model="removalCriteria.type">
                            <option value="">Selecione um critério...</option>
                            <option value="by_user">Por Usuário</option>
                            <option value="by_point">Por Ponto Específico</option>
                            <option value="by_time_range">Por Período</option>
                            <option value="incomplete_only">Apenas Incompletas</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6" ng-show="removalCriteria.type">
                    <div class="form-group" ng-show="removalCriteria.type === 'by_user'">
                        <label>Usuário:</label>
                        <select class="form-control" ng-model="removalCriteria.user">
                            <option value="">Selecione o usuário...</option>
                            <option ng-repeat="user in availableUsers" value="{{user}}">{{user}}</option>
                        </select>
                    </div>
                    <div class="form-group" ng-show="removalCriteria.type === 'by_point'">
                        <label>ID do Ponto:</label>
                        <input type="text" class="form-control" ng-model="removalCriteria.pointId" placeholder="Digite o ID do ponto">
                    </div>
                    <div ng-show="removalCriteria.type === 'by_time_range'">
                        <label>Data Inicial:</label>
                        <input type="date" class="form-control" ng-model="removalCriteria.startDate">
                        <label style="margin-top: 5px;">Data Final:</label>
                        <input type="date" class="form-control" ng-model="removalCriteria.endDate">
                    </div>
                </div>
            </div>
            <div ng-show="removalCriteria.type" style="margin-top: 15px;">
                <button class="btn btn-warning" ng-click="previewRemoval()" ng-disabled="!isRemovalCriteriaValid()">
                    <i class="glyphicon glyphicon-search"></i> Visualizar Impacto
                </button>
                <button class="btn btn-danger" ng-click="confirmRemoval()" ng-disabled="!removalPreview.length" style="margin-left: 10px;">
                    <i class="glyphicon glyphicon-trash"></i> Remover Inspeções
                </button>
            </div>
            <div ng-show="removalPreview.length > 0" style="margin-top: 15px;">
                <div class="alert alert-info">
                    <strong>Impacto da Remoção:</strong> {{ removalPreview.length }} inspeções serão removidas de {{ removalPreview.pointsAffected }} pontos.
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-condensed">
                        <thead>
                            <tr>
                                <th>Ponto</th>
                                <th>Usuário</th>
                                <th>Data</th>
                                <th>Impacto</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="preview in removalPreview | limitTo:20">
                                <td>{{ preview.pointId }}</td>
                                <td>{{ preview.user }}</td>
                                <td>{{ preview.date | date:'dd/MM/yyyy' }}</td>
                                <td>
                                    <span class="label" ng-class="preview.impact === 'safe' ? 'label-success' : 'label-warning'">
                                        {{ preview.impact === 'safe' ? 'Seguro' : 'Atenção' }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div ng-if="loading" class="text-center">
        <i class="glyphicon glyphicon-refresh glyphicon-spin"></i> Carregando pontos...
    </div>
    
    <table ng-if="!loading && points.length > 0" class="table table-striped table-condensed">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" ng-model="selectAll" ng-change="toggleSelectAll()"> ID
                </th>
                <th>Lat</th>
                <th>Lon</th>
                <th>Bioma</th>
                <th>UF</th>
                <th>Município</th>
                <th>Inspeções</th>
                <th>Status</th>
                <th>Usuários</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="point in points" ng-class="{'warning': point.selected}">
                <td>
                    <input type="checkbox" ng-model="point.selected" ng-change="updateSelection()">
                    {{ point._id }}
                </td>
                <td>{{ point.lat | number:6 }}</td>
                <td>{{ point.lon | number:6 }}</td>
                <td>{{ point.biome || '-' }}</td>
                <td>{{ point.uf || '-' }}</td>
                <td>{{ point.county || '-' }}</td>
                <td>
                    <span class="badge" ng-class="getInspectionBadgeClass(getInspectionCount(point), campaign.numInspec)">
                        {{ getInspectionCount(point) }}
                    </span>
                </td>
                <td>
                    <span ng-if="getInspectionCount(point) >= campaign.numInspec" class="label label-success">Completo</span>
                    <span ng-if="getInspectionCount(point) < campaign.numInspec && getInspectionCount(point) > 0" class="label label-warning">Em andamento</span>
                    <span ng-if="getInspectionCount(point) == 0" class="label label-default">Não iniciado</span>
                </td>
                <td>
                    <div ng-if="getInspectionCount(point) > 0" style="max-width: 150px;">
                        <span ng-repeat="user in point.userName | limitTo:3" class="label label-info" style="margin-right: 2px; font-size: 10px;">
                            {{ user | limitTo:8 }}{{ user.length > 8 ? '...' : '' }}
                        </span>
                        <span ng-if="getInspectionCount(point) > 3" class="text-muted">
                            +{{ getInspectionCount(point) - 3 }}
                        </span>
                    </div>
                    <span ng-if="getInspectionCount(point) == 0" class="text-muted">-</span>
                </td>
                <td>
                    <div class="btn-group btn-group-xs">
                        <button class="btn btn-default" ng-click="viewPointDetails(point)" title="Ver detalhes">
                            <i class="glyphicon glyphicon-eye-open"></i>
                        </button>
                        <button class="btn btn-warning" ng-click="editPointInspections(point)" title="Editar inspeções" ng-disabled="getInspectionCount(point) == 0">
                            <i class="glyphicon glyphicon-edit"></i>
                        </button>
                        <button class="btn btn-danger" ng-click="removePointInspections(point)" title="Remover inspeções" ng-disabled="getInspectionCount(point) == 0">
                            <i class="glyphicon glyphicon-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    
    <!-- Ações em lote para pontos selecionados -->
    <div ng-show="selectedPoints.length > 0" class="alert alert-info">
        <strong>{{ selectedPoints.length }} pontos selecionados:</strong>
        <div class="btn-group" style="margin-left: 10px;">
            <button class="btn btn-warning btn-sm" ng-click="bulkEditInspections()">
                <i class="glyphicon glyphicon-edit"></i> Editar em Lote
            </button>
            <button class="btn btn-danger btn-sm" ng-click="bulkRemoveInspections()">
                <i class="glyphicon glyphicon-trash"></i> Remover em Lote
            </button>
            <button class="btn btn-info btn-sm" ng-click="exportSelectedPoints()">
                <i class="glyphicon glyphicon-download-alt"></i> Exportar
            </button>
        </div>
    </div>
    
    <div ng-if="!loading && points.length == 0" class="alert alert-info">
        <span ng-if="hasActiveFilters()">Nenhum ponto encontrado com os filtros aplicados.</span>
        <span ng-if="searchId && !hasActiveFilters()">Nenhum ponto encontrado com o ID "{{searchId}}".</span>
        <span ng-if="!searchId && !hasActiveFilters()">Nenhum ponto encontrado para esta campanha.</span>
    </div>
    
    <!-- Informações de paginação -->
    <div ng-if="!loading && (totalPoints > 0 || searchId)" class="row" style="margin-top: 15px;">
        <div class="col-md-6">
            <p class="text-muted">
                <span ng-if="!searchId">
                    Mostrando {{points.length}} de {{totalPoints}} pontos
                    (Página {{currentPage}} de {{getTotalPages()}})
                </span>
                <span ng-if="searchId && points.length > 0">
                    {{points.length}} resultado(s) encontrado(s) para "{{searchId}}"
                </span>
                <span ng-if="hasActiveFilters()" class="label label-warning">Filtrado</span>
            </p>
        </div>
        <div class="col-md-6 text-right">
            <div class="form-inline">
                <label>Pontos por página:</label>
                <select class="form-control input-sm" 
                        ng-model="pageSize" 
                        ng-change="changePageSize()"
                        ng-disabled="searchId"
                        style="width: 80px; margin-left: 5px;">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Controles de paginação -->
    <div ng-if="!searchId && getTotalPages() > 1" class="row" style="margin-top: 10px;">
        <div class="col-lg-12">
            <nav class="text-center">
                <ul class="pagination pagination-sm">
                    <!-- Primeira página -->
                    <li ng-class="{disabled: currentPage <= 1}">
                        <a href="" ng-click="goToPage(1); $event.preventDefault()" ng-disabled="currentPage <= 1">
                            <i class="glyphicon glyphicon-fast-backward"></i>
                        </a>
                    </li>
                    
                    <!-- Página anterior -->
                    <li ng-class="{disabled: currentPage <= 1}">
                        <a href="" ng-click="goToPage(currentPage - 1); $event.preventDefault()" ng-disabled="currentPage <= 1">
                            <i class="glyphicon glyphicon-chevron-left"></i>
                        </a>
                    </li>
                    
                    <!-- Páginas numeradas -->
                    <li ng-repeat="page in getPages()" 
                        ng-class="{active: page === currentPage}">
                        <a href="" ng-click="goToPage(page); $event.preventDefault()">{{page}}</a>
                    </li>
                    
                    <!-- Próxima página -->
                    <li ng-class="{disabled: currentPage >= getTotalPages()}">
                        <a href="" ng-click="goToPage(currentPage + 1); $event.preventDefault()" ng-disabled="currentPage >= getTotalPages()">
                            <i class="glyphicon glyphicon-chevron-right"></i>
                        </a>
                    </li>
                    
                    <!-- Última página -->
                    <li ng-class="{disabled: currentPage >= getTotalPages()}">
                        <a href="" ng-click="goToPage(getTotalPages()); $event.preventDefault()" ng-disabled="currentPage >= getTotalPages()">
                            <i class="glyphicon glyphicon-fast-forward"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>
<div class="modal-footer">
    <button class="btn btn-default" ng-click="close()">Fechar</button>
</div>